{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Phlow Phlow Schema",
    "description": "Schema for Phlow phlow files",
    "type": "object",
    "properties": {
        "main": {
            "type": "string",
            "description": "Main module name (optional)",
            "examples": [
                "cli",
                "http_server",
                "consumer"
            ]
        },
        "name": {
            "type": "string",
            "description": "Phlow name",
            "minLength": 1
        },
        "version": {
            "type": "string",
            "description": "Phlow version (semantic versioning)",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "description": {
            "type": "string",
            "description": "Phlow description"
        },
        "author": {
            "type": "string",
            "description": "Phlow author"
        },
        "tags": {
            "type": "array",
            "description": "Phlow tags",
            "items": {
                "type": "string"
            }
        },
        "modules": {
            "oneOf": [
                {
                    "type": "array",
                    "description": "List of modules",
                    "items": {
                        "$ref": "#/definitions/module"
                    }
                },
                {
                    "type": "string",
                    "description": "Include directive for modules",
                    "pattern": "^!include\\s+.+$"
                }
            ]
        },
        "steps": {
            "type": "array",
            "description": "Phlow execution steps",
            "items": {
                "$ref": "#/definitions/step"
            },
            "minItems": 1
        },
        "tests": {
            "type": "array",
            "description": "Test cases for the phlow",
            "items": {
                "$ref": "#/definitions/test"
            }
        }
    },
    "required": [
        "steps"
    ],
    "additionalProperties": true,
    "definitions": {
        "module": {
            "type": "object",
            "properties": {
                "module": {
                    "type": "string",
                    "description": "Module name",
                    "examples": [
                        "cli",
                        "postgres",
                        "log",
                        "http_server",
                        "producer",
                        "consumer"
                    ]
                },
                "version": {
                    "type": "string",
                    "description": "Module version",
                    "default": "latest"
                },
                "with": {
                    "type": "object",
                    "description": "Module configuration",
                    "additionalProperties": true
                }
            },
            "required": [
                "module"
            ],
            "additionalProperties": false
        },
        "step": {
            "type": "object",
            "properties": {
                "id": {
                    "type": "string",
                    "description": "Step identifier"
                },
                "label": {
                    "type": "string",
                    "description": "Step label for tracing"
                },
                "assert": {
                    "description": "Condition to evaluate",
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "boolean"
                        }
                    ]
                },
                "then": {
                    "description": "Action if assertion is true",
                    "anyOf": [
                        {
                            "$ref": "#/definitions/step"
                        },
                        {
                            "$ref": "#/definitions/stepList"
                        }
                    ]
                },
                "else": {
                    "description": "Action if assertion is false",
                    "anyOf": [
                        {
                            "$ref": "#/definitions/step"
                        },
                        {
                            "$ref": "#/definitions/stepList"
                        }
                    ]
                },
                "payload": {
                    "description": "Data to pass to next step",
                    "anyOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "object"
                        },
                        {
                            "type": "array"
                        },
                        {
                            "type": "number"
                        },
                        {
                            "type": "boolean"
                        }
                    ]
                },
                "return": {
                    "description": "Return value",
                    "anyOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "object"
                        },
                        {
                            "type": "array"
                        },
                        {
                            "type": "number"
                        },
                        {
                            "type": "boolean"
                        }
                    ]
                },
                "use": {
                    "type": "string",
                    "description": "Module to use in this step"
                },
                "input": {
                    "type": "object",
                    "description": "Input parameters for module",
                    "additionalProperties": true
                },
                "to": {
                    "type": "string",
                    "description": "Next step ID"
                },
                "steps": {
                    "type": "array",
                    "description": "Nested steps",
                    "items": {
                        "$ref": "#/definitions/step"
                    }
                }
            },
            "additionalProperties": false
        },
        "stepList": {
            "type": "object",
            "properties": {
                "steps": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/step"
                    }
                }
            },
            "required": [
                "steps"
            ],
            "additionalProperties": false
        },
        "test": {
            "type": "object",
            "description": "Test case definition",
            "properties": {
                "main": {
                    "type": "object",
                    "description": "Main context for the test",
                    "additionalProperties": true
                },
                "payload": {
                    "description": "Initial payload for the test",
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "object"
                        },
                        {
                            "type": "array"
                        },
                        {
                            "type": "number"
                        },
                        {
                            "type": "boolean"
                        }
                    ]
                },
                "assert_eq": {
                    "description": "Assert that the result equals this value",
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "object"
                        },
                        {
                            "type": "array"
                        },
                        {
                            "type": "number"
                        },
                        {
                            "type": "boolean"
                        }
                    ]
                },
                "assert": {
                    "type": "string",
                    "description": "PHS expression that should evaluate to true",
                    "pattern": "^!phs\\s+.+"
                }
            },
            "additionalProperties": false
        }
    }
}